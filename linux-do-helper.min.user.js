// ==UserScript==
// @name         Linux.do ç¤¾åŒºåŠ©æ‰‹
// @namespace    http://tampermonkey.net/
// @version      1.0.1
// @description  ä¸º Linux.do æ·»åŠ å¿«æ·è¯„è®ºå’Œå›åˆ°é¡¶éƒ¨
// @author       You
// @match        https://linux.do/*
// @grant        none
// @run-at       document-end
// ==/UserScript==

!function(){"use strict";const e="linuxdo_quick_comments",t="40px",n="40px",o="å¸¸ç”¨è¯„è®º",r="å¿«æ·è¯„è®º",a="å›åˆ°é¡¶éƒ¨",i="è¾“å…¥æ–°çš„å¸¸ç”¨è¯„è®º...",c="æ·»åŠ ",s="æš‚æ— å¸¸ç”¨è¯„è®º<br>è¯·å…ˆæ·»åŠ ",d="æœªæ‰¾åˆ°å›å¤æŒ‰é’®ï¼Œè¯·ç¡®ä¿åœ¨å¸–å­é¡µé¢",l="ç­‰å¾…å…ƒç´ è¶…æ—¶",m="å‘é€è¯„è®ºå¤±è´¥: ",u=["button.btn-primary.create",'button[aria-label*="å›å¤"]',".topic-footer-main-buttons button.create","#topic-footer-buttons button.create","button.reply"],p=[".d-editor-input","textarea.d-editor-input","#reply-control textarea",'textarea[aria-label*="è¯„è®º"]'],b=["#reply-control button.btn-primary.create","button.btn-primary.create",'button[aria-label*="å‘é€"]',".submit-panel button.create"];class x{constructor(){this.comments=this.load()}load(){try{return JSON.parse(localStorage.getItem(e)||"[]")}catch(e){return console.error("åŠ è½½è¯„è®ºå¤±è´¥:",e),[]}}save(){try{localStorage.setItem(e,JSON.stringify(this.comments))}catch(e){console.error("ä¿å­˜è¯„è®ºå¤±è´¥:",e)}}add(e){const t=e&&e.trim();return!!t&&(this.comments.push({id:Date.now(),text:t}),this.save(),!0)}remove(e){this.comments=this.comments.filter(t=>t.id!==e),this.save()}getAll(){return this.comments}}const f=(e,t=document)=>t.querySelector(e),h=e=>e&&null!==e.offsetParent,g=e=>{for(const t of e){const e=f(t);if(h(e))return e}return null};function v(e){const t=f("#comments-list");if(!t)return;const n=e.getAll();n.length?t.innerHTML=n.map(e=>`\n<div class="comment-item" data-id="${e.id}">\n  <span class="comment-text">${e.text}</span>\n  <span class="comment-delete" data-id="${e.id}">Ã—</span>\n</div>`).join(""):t.innerHTML=`<div class="empty-message">${s}</div>`}function y(e,t=5e3){return new Promise((n,o)=>{const r=g(e);if(r)return void n(r);const a=new MutationObserver(()=>{const t=g(e);t&&(clearTimeout(i),a.disconnect(),n(t))}),i=setTimeout(()=>{a.disconnect(),o(new Error(l))},t);a.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})})}async function k(e){try{const n=(e=>{for(const t of e){const e=f(t);if(e)return e}return null})(u);if(!n)return void alert(d);n.click();const o=await y(p,5e3);o.value=e,o.focus(),function(e){["input","change","keyup"].forEach(t=>{e.dispatchEvent(new Event(t,{bubbles:!0,cancelable:!0}))})}(o),await(t=300,new Promise(e=>setTimeout(e,t))),(await y(b,3e3)).click()}catch(e){console.error("å‘é€è¯„è®ºå¤±è´¥:",e),alert(m+e.message)}var t}function w(){const e=new x;!function(){const e=document.createElement("style");e.textContent=`\n#linuxdo-float-bar{position:fixed;right:16px;top:50%;transform:translateY(-50%);width:${t};background:rgba(255,255,255,.95);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:6px;z-index:9999;display:flex;flex-direction:column;gap:6px}\n.linuxdo-btn{width:${n};height:${n};border:none;border-radius:8px;background:#f0f0f0;color:#333;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all .2s}\n.linuxdo-btn:hover{background:#e0e0e0;transform:scale(1.08)}\n#linuxdo-comments-panel{position:fixed;right:80px;top:50%;transform:translateY(-50%);width:280px;max-height:480px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:9998;display:none;flex-direction:column;overflow:hidden}\n#linuxdo-comments-panel.show{display:flex}\n.comments-panel-header{padding:12px 14px;border-bottom:1px solid #e8e8e8;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:14px}\n.comments-panel-header span:last-child{cursor:pointer;opacity:.6;font-size:18px}\n.comments-panel-header span:last-child:hover{opacity:1}\n.comments-panel-body{flex:1;overflow-y:auto;padding:8px}\n.comments-panel-body::-webkit-scrollbar{width:6px}\n.comments-panel-body::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px}\n.comment-item{padding:8px 10px;margin-bottom:6px;background:#f8f8f8;border-radius:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all .2s}\n.comment-item:hover{background:#ececec;transform:translateX(-2px)}\n.comment-text{flex:1;word-break:break-word;font-size:12px;color:#555;line-height:1.4}\n.comment-delete{color:#ff6b6b;cursor:pointer;padding:2px 6px;margin-left:8px;font-size:16px;opacity:.6}\n.comment-delete:hover{opacity:1}\n.comments-panel-footer{padding:8px;border-top:1px solid #e8e8e8}\n.add-comment-input{width:100%;padding:8px 10px;border:1px solid #e0e0e0;border-radius:6px;margin-bottom:6px;font-size:12px;box-sizing:border-box}\n.add-comment-input:focus{outline:none;border-color:#999}\n.add-comment-btn{width:100%;padding:8px;background:#333;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500}\n.add-comment-btn:hover{background:#444}\n.empty-message{text-align:center;color:#999;padding:20px;font-size:12px}\n@media (prefers-color-scheme: dark){\n  #linuxdo-float-bar{background:rgba(30,30,30,.95)}\n  .linuxdo-btn{background:#2a2a2a;color:#e0e0e0}\n  .linuxdo-btn:hover{background:#3a3a3a}\n  #linuxdo-comments-panel{background:#1e1e1e}\n  .comments-panel-header{border-bottom-color:#333;color:#e0e0e0}\n  .comments-panel-body::-webkit-scrollbar-thumb{background:#444}\n  .comment-item{background:#2a2a2a}\n  .comment-item:hover{background:#333}\n  .comment-text{color:#ccc}\n  .comments-panel-footer{border-top-color:#333}\n  .add-comment-input{background:#2a2a2a;border-color:#444;color:#e0e0e0}\n  .add-comment-input:focus{border-color:#666}\n  .add-comment-btn{background:#4a4a4a}\n  .add-comment-btn:hover{background:#5a5a5a}\n  .empty-message{color:#666}\n}`,document.head.appendChild(e)}(),function(){const e=document.createElement("div");e.id="linuxdo-float-bar",e.innerHTML=`\n<button class="linuxdo-btn" id="quick-comment-btn" title="${r}">ğŸ’¬</button>\n<button class="linuxdo-btn" id="back-to-top-btn" title="${a}">â¬†ï¸</button>`;const t=document.createElement("div");t.id="linuxdo-comments-panel",t.innerHTML=`\n<div class="comments-panel-header">\n  <span>${o}</span>\n  <span id="close-panel">âœ•</span>\n</div>\n<div class="comments-panel-body" id="comments-list"></div>\n<div class="comments-panel-footer">\n  <input type="text" class="add-comment-input" id="new-comment-input" placeholder="${i}">\n  <button class="add-comment-btn" id="add-comment-btn">${c}</button>\n</div>`;const n=document.createDocumentFragment();n.appendChild(e),n.appendChild(t),document.body.appendChild(n)}(),v(e);const s=f("#linuxdo-comments-panel"),d=f("#quick-comment-btn"),l=f("#back-to-top-btn"),m=f("#close-panel"),u=f("#add-comment-btn"),p=f("#new-comment-input"),b=f("#comments-list");if(!(s&&d&&l&&m&&u&&p&&b))return;let h=null,g=!1;const y=()=>clearTimeout(h),w=(e,t)=>{h=setTimeout(()=>{t()&&s.classList.remove("show")},e)},L=()=>{d.style.display=f("#current-user, .current-user")?"flex":"none"};L();let E=null;new MutationObserver(()=>{E||(E=setTimeout(()=>{L(),E=null},500))}).observe(document.body,{childList:!0,subtree:!0}),d.addEventListener("mouseenter",()=>{y(),s.classList.add("show")}),d.addEventListener("mouseleave",()=>w(200,()=>!s.matches(":hover")&&!g)),s.addEventListener("mouseenter",y),s.addEventListener("mouseleave",()=>w(100,()=>!g)),p.addEventListener("focus",()=>{g=!0,y()}),p.addEventListener("blur",()=>{g=!1,w(200,()=>!s.matches(":hover"))}),m.addEventListener("click",()=>s.classList.remove("show")),l.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"})),u.addEventListener("click",()=>{e.add(p.value)&&(p.value="",v(e))}),p.addEventListener("keypress",e=>{"Enter"===e.key&&u.click()}),b.addEventListener("click",t=>{const n=t.target.closest(".comment-delete");if(n)return e.remove(parseInt(n.dataset.id,10)),void v(e);const o=t.target.closest(".comment-item");if(!o)return;const r=parseInt(o.dataset.id,10),a=e.getAll().find(e=>e.id===r);a&&(k(a.text),s.classList.remove("show"))})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",w):w()}();
